<% if @job_id && @error_msg.nil? && @script_path.nil? %>
  <div class="alert alert-success alert-dismissible mx-1 mb-0">
    Job was successfully submitted (Job ID is <%= @job_id %>).
    <% if @conf.key?("clusters") && @conf["clusters"].size > 1 %>
    Go to the <a href="./history?cluster=<%= @cluster_name %>">History page</a>.
    <% else %>
    Go to the <a href="./history">History page</a>.
    <% end %>
    <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% elsif !@error_msg.nil? %>
  <div class="alert alert-warning alert-dismissible mx-1 mb-0">
    Job submission failed. (<%= @error_msg %>)
    <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% elsif !@script_path.nil? %>
  <div class="alert alert-info alert-dismissible mx-1 mb-0">
    Saved to the following path: <a target="_blank" href="<%= @my_ood_url %>/pun/sys/dashboard/files/fs<%= File.dirname(@script_path) %>"><%= @script_path %></a>
    <% unless @login_node.nil? %>
    <a style="color: black; text-decoration: none; vertical-align: middle;" target="_blank" href="<%= @my_ood_url %>/pun/sys/shell/ssh/<%= @login_node %>/<%= File.dirname(@script_path) %>">
      <i class="bi bi-terminal-fill fs-5"></i>
    </a>
    <% end %>
    <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>

<form id="<%= SUBMIT_FORM %>" action="<%= @current_path %>" method="post" onsubmit="return ocForm.submitEffect('<%= @form_action %>');">
  <div class="row px-3 text-white">
    <!-- Application Info Section -->
    <div class="col pt-2 bg-gradient" style="background:<%= @conf['description_color'] %>; color: white;">
      <h3>
        <a href="<%= @script_name %>/<%= @manifest['dirname'] %>" class="fw-semibold" style="color: inherit; text-decoration: none;">
          <%= @manifest['name'] %>
        </a>
      </h3>
      <input type="hidden" name="<%= JOB_APP_NAME %>" value="<%= @manifest['name'] %>">
      <input type="hidden" name="<%= JOB_DIR_NAME %>" value="<%= @dir_name %>">
      <p><%= @manifest['description'] %></p>
    </div>

    <!-- Header -->
    <div class="col pt-2 pb-0 bg-gradient" style="background: <%= @conf['description_color'] %>;">
      <%= output_header(@body, @header) %>
    </div>
  </div>

  <div id="<%= FORM_LAYOUT %>" class="row row-cols-1 row-cols-lg-2 mx-1 bg-gradient" style="background: <%= @conf['form_color'] %>;">
    <!-- Form Body -->
    <div class="col py-3">
      <%= output_body(@body, @header, @manifest['name'], @manifest['dirname']) %>
    </div>

    <!-- Script Content Section -->
    <div class="col py-3 d-flex flex-column">
      <label id="label_<%= OC_SCRIPT_CONTENT %>" class="fw-semibold" for="<%= OC_SCRIPT_CONTENT %>"><%= @script_label %></label>
      <textarea id="<%= OC_SCRIPT_CONTENT %>" name="<%= OC_SCRIPT_CONTENT %>" class="form-control mt-1 mb-3 flex-grow-1" tabindex="<%= @table_index %>" accesskey="s" oninput="ocForm.updateHeight(ocForm.scriptArea)" required></textarea>
      <!-- Submit Button -->
      <% if @form_action == "confirm" || @form_action == "confirm-save" %>
      <button class="btn btn-primary d-block w-100" id="<%= SUBMIT_BUTTON %>" type="button" data-bs-toggle="modal" data-bs-target="#modal-<%= SUBMIT_CONFIRM %>" tabindex="<%= @table_index + 1 %>">
        Confirm
      </button>
      <% else %>
      <input type="submit" class="btn btn-primary d-block w-100" id="<%= SUBMIT_BUTTON %>" value="<%= @form_action.capitalize %>" tabindex="<%= @table_index + 1 %>">
      <% end %>
      <div class="modal fade" id="modal-<%= SUBMIT_CONFIRM %>" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="overflow-y: initial !important;">
          <div class="modal-content">
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
              <div class="container-fluid">
                <div class="row">
                  <div class="col">
		    <textarea id="<%= SUBMIT_CONTENT %>" name="<%= SUBMIT_CONTENT %>" class="form-control flex-grow-1 w-100" rows="6" oninput="ocForm.updateHeight(ocForm.submitArea)">
		      (Something Wrong)
		    </textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
		<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
		  <% if @form_action == "confirm" %>
		  <button class="btn btn-primary" form="<%= SUBMIT_FORM %>" type="submit" form="main-form">Submit</button>
		  <% elsif @form_action == "confirm-save" %>
                  <button class="btn btn-primary" form="<%= SUBMIT_FORM %>" type="submit" form="main-form">Save</button>
		  <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
<script>
var ocForm = ocForm || {};
ocForm.scriptArea = document.getElementById('<%= OC_SCRIPT_CONTENT %>');
ocForm.submitArea = document.getElementById('<%= SUBMIT_CONTENT %>');
</script>
<script src="form.js"></script>
<script>
// Executes functions that should run once.
ocForm.onceExec = function() {
<%= @js["once"].chomp %>
};

// Initialize dynamic form widgets.
ocForm.initDynamicWidget = function(fromId) {
<%= @js["init_dw"].lines.map(&:chomp).sort.uniq.join("\n") %>
};

// Execute dynamic form widgets.
ocForm.execDynamicWidget = function(fromId) {
<%= @js["exec_dw"].chomp %>
};

// Update the script section.
ocForm.updateScriptContents = function(selectedValues) {
<%= @js["script"].chomp %>
};

// Update the submit section.
ocForm.updateSubmitContents = function(selectedValues) {
<%= @js["submit"].chomp %>
};

// Check if a cache file exists.
ocForm.isScriptCache = function() {
  return <%= @script_content != nil %>;
};

ocForm.isSubmitCache = function() {
  return <%= @submit_content != nil %>;
};

// Load cache file contents.
// Since @script_content uses escape_html() in ruby, it is converted using textarea to decode.
ocForm.loadScriptCache = function() {
  const textarea = document.createElement('textarea');
  textarea.innerHTML = <%= @script_content.to_json %>;
  return textarea.value;
};

// Load cache file contents.
// Since @submit_content uses escape_html() in ruby, it is converted using textarea to decode.
ocForm.loadSubmitCache = function() {
  const textarea = document.createElement('textarea');
  textarea.innerHTML = <%= @submit_content.to_json %>;
  return textarea.value;
};

// Prevent default behavior for Enter key unless specific elements are focused.
document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && (event.target.id !== '<%= OC_SCRIPT_CONTENT %>' && event.target.id !== '<%= SUBMIT_BUTTON %>' && event.target.id !== '<%= SUBMIT_CONTENT %>')) {
    event.preventDefault();
  }
});

// Split text into shebang, header (SBATCH lines) and body
function splitText(text){
    text = (text ?? '').toString();
    const lines = text.split('\n');
    let shebang = '';
    const header = [];
    const body = [];

    for (const line of lines) {
      const trimmed = line.trim();
      if (!shebang && trimmed.startsWith("#!")) { shebang = trimmed; }
      else if (trimmed.startsWith("#SBATCH")) { header.push(trimmed); }
      else if (body.at(-1)!="" || trimmed!="") { body.push(trimmed); }
    }

    return { shebang, header, body }
}

// Temporary function to test changes
function rebuildWithSbatchHeader(currentText, headerText) {
  console.group("test function");
  
  const { shebang: currentShebang, header: currentHeader, body: currentBody } = splitText(currentText);
  const { shebang: renderedShebang, header: renderedHeader, body: renderedBody } = splitText(headerText);

  const finalShebang = renderedShebang ? renderedShebang : currentShebang || '';
  const finalHeader = renderedHeader?.length>0 ? renderedHeader : currentHeader?.length>0 ? currentHeader : [];

  const filteredRenderedBody = renderedBody.filter(item => item.trim() !== "");
  const filteredCurrentBody  = currentBody.filter(item => item.trim() !== "");
  let finalBody;
  if (filteredRenderedBody.length === 0 && filteredCurrentBody.length === 0) { finalBody = []; }
  else if (filteredRenderedBody.length === 0) { finalBody = currentBody; }
  else if (filteredCurrentBody.length === 0) { finalBody = renderedBody; }
  else { finalBody = [...renderedBody, "", ...currentBody]; }
  if (finalBody[0] === "") { finalBody.shift(); }
  if (finalBody.at(-1) === "") { finalBody.pop(); }

  const hasTopSection = (finalShebang?.trim()!=='') || (finalHeader.length>0);
  const combined = [
    ...(finalShebang ? [finalShebang] : []),
    ...finalHeader,
    ...(hasTopSection && finalBody.length>0 ? [""] : []),
    ...finalBody
  ];
  const finalText = combined.join("\n");

  console.log("finalText", finalText)
  console.groupEnd();

  return finalText;
}

ocForm.isFirst = true;
ocForm.multiSelectDisabledIndexes = {};
ocForm.updateValues = function(fromId) {
  console.group("updateValues");
  let scriptValues = [];
  let submitValues = [];
  ocForm.initDynamicWidget(fromId);
  ocForm.execDynamicWidget(fromId);

  if (ocForm.isFirst) {
    ocForm.isFirst = false;
    ocForm.onceExec();
    ocForm.updateScriptContents(scriptValues);
    ocForm.updateSubmitContents(submitValues);

    // Overwrite of script textarea (first run)
    //ocForm.scriptArea.value = ocForm.isScriptCache() ? ocForm.loadScriptCache() : Object.values(scriptValues).join('\n');
    const newHeaderFirst = Object.values(scriptValues).join('\n');
    const baseTextFirst = ocForm.isScriptCache() ? ocForm.loadScriptCache() : (ocForm.scriptArea.value || '');
    ocForm.scriptArea.value = rebuildWithSbatchHeader(baseTextFirst, newHeaderFirst);

    // Overwrite of submit textarea (first run)
    ocForm.submitArea.value = ocForm.isSubmitCache() ? ocForm.loadSubmitCache() : Object.values(submitValues).join('\n');
  }

  else {
    ocForm.updateScriptContents(scriptValues);
    ocForm.updateSubmitContents(submitValues);

    // Overwrite of script textarea (subsequent runs)
    //ocForm.scriptArea.value = Object.values(scriptValues).join('\n');
    const newHeaderNext = Object.values(scriptValues).join('\n');
    //ocForm.scriptArea.value = rebuildWithSbatchHeader(ocForm.scriptArea.value || '', newHeaderNext);
    ocForm.scriptArea.value = rebuildWithSbatchHeader2(ocForm.scriptArea.value || '', newHeaderNext);

    // Overwrite of submit textarea (subsequent runs)
    ocForm.submitArea.value = Object.values(submitValues).join('\n')
  }

  // Add a newline if it is not the last one
  //if (!ocForm.scriptArea.value.endsWith('\n')){
  //  ocForm.scriptArea.value += '\n';
  //}
  //if (!ocForm.submitArea.value.endsWith('\n')){
  //  ocForm.submitArea.value += '\n';
  //}

  // Height adjustments
  ocForm.updateHeight(ocForm.scriptArea);
  ocForm.updateHeight(ocForm.submitArea);
  console.groupEnd();
};

window.onload = ocForm.updateValues();
</script>
